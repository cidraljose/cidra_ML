<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}Cidra-ML{% endblock %}</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container-fluid">
        <a class="navbar-brand" href="{% url 'home_view' %}">Home</a>
        <div class="collapse navbar-collapse">
          <ul class="navbar-nav me-auto">
            <li class="nav-item"><a class="nav-link" href="{% url 'manage_datasets_view' %}">Datasets ðŸŽ²</a></li>
            <li class="nav-item"><a class="nav-link" href="{% url 'manage_MLmodels_view' %}">Models ðŸ¤–</a></li>
            {% comment %} <li class="nav-item"><a class="nav-link" href="{% url 'teste_modelo_view' %}">Teste ðŸ§ª</a></li> {% endcomment %}
            {% comment %} <li class="nav-item"><a class="nav-link" href="{% url 'historico_view' %}">HistÃ³rico ðŸ“°</a></li> {% endcomment %}
            {% comment %} <li class="nav-item"><a class="nav-link" href="{% url 'metadados_view' %}">Metadados ðŸ”§</a></li> {% endcomment %}
          </ul>
        </div>
      </div>
    </nav>

    <!-- Main content -->
    <div class="container mt-4">
        {% block content %}{% endblock %}
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tries to locate by IDs (prefix 'train') or by name if ID doesn't exist
    const datasetSelect = document.getElementById('id_train-dataset') || document.querySelector('select[name="train-dataset"]');
    const targetSelect = document.getElementById('id_train-target') || document.querySelector('select[name="train-target"]');
    const featuresSelect = document.getElementById('id_train-features') || document.querySelector('select[name="train-features"]');

    if (!datasetSelect || !targetSelect || !featuresSelect) {
        console.warn('Elementos do form nÃ£o encontrados:', {datasetSelect, targetSelect, featuresSelect});
        return;
    }

    // URL template generated by reverse (using 0 as placeholder)
    const urlTemplate = "{% url 'get_dataset_columns_view' 0 %}";
    function buildUrl(datasetId) {
        if (!datasetId) return null;
        return urlTemplate.replace(/0\/?$/, datasetId + '/');
    }

    // Values that the view might have injected (to maintain selection after error)
    const serverSelectedTarget = "{{ selected_target|default:''|escapejs }}";
    const serverSelectedFeatures = {{ selected_features_json|default:"[]"|safe }};

    function clearAndShowLoading() {
        targetSelect.innerHTML = '<option value="">Loading...</option>';
        featuresSelect.innerHTML = '';
    }

    function populateSelects(columns) {
        // target
        targetSelect.innerHTML = '';
        const emptyOp = document.createElement('option');
        emptyOp.value = '';
        emptyOp.textContent = '---------';
        targetSelect.appendChild(emptyOp);

        columns.forEach(col => {
            const opt = new Option(col, col);
            targetSelect.appendChild(opt);
        });

        // Reapply server selection, if any
        if (serverSelectedTarget) {
            const opt = Array.from(targetSelect.options).find(o => o.value === serverSelectedTarget);
            if (opt) opt.selected = true;
        }

        featuresSelect.innerHTML = '';
        // Features (multiple)
        columns.forEach(col => {
            const opt = new Option(col, col);
            // marca se estava selecionado antes (serverSelectedFeatures Ã© array)
            if (Array.isArray(serverSelectedFeatures) && serverSelectedFeatures.indexOf(col) !== -1) {
                opt.selected = true;
            }
            featuresSelect.appendChild(opt);
        });
    }

    function fetchAndPopulate(datasetId) {
        if (!datasetId) {
            targetSelect.innerHTML = '<option value="">Select a dataset first</option>';
            featuresSelect.innerHTML = '';
            return;
        }
        const url = buildUrl(datasetId);
        if (!url) return;
        clearAndShowLoading();

        fetch(url, {credentials: 'same-origin'})
            .then(r => {
                if (!r.ok) throw new Error('HTTP ' + r.status);
                return r.json();
            })
            .then(data => {
                const cols = Array.isArray(data.columns) ? data.columns : [];
                if (cols.length === 0) {
                    targetSelect.innerHTML = '<option value="">No columns found</option>';
                    featuresSelect.innerHTML = '';
                    return;
                }
                populateSelects(cols);
            })
            .catch(err => {
                console.error('Error fetching columns:', err);
                targetSelect.innerHTML = '<option value="">Error loading columns</option>';
                featuresSelect.innerHTML = '';
            });
    }

    // Change event for the dataset select
    datasetSelect.addEventListener('change', function() {
        fetchAndPopulate(this.value);
    });

    // auto-popula ao carregar caso jÃ¡ haja um dataset selecionado (ex.: reload com form com erro)
    if (datasetSelect.value) {
        fetchAndPopulate(datasetSelect.value);
    }
});
</script>
{% endblock %}
