<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}Cidra-ML{% endblock %}</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container-fluid">
        <a class="navbar-brand" href="{% url 'home_view' %}">Home üçã</a>
        <div class="collapse navbar-collapse">
          <ul class="navbar-nav me-auto">
            <li class="nav-item"><a class="nav-link" href="{% url 'manage_datasets_view' %}">Datasets üé≤</a></li>
            <li class="nav-item"><a class="nav-link" href="{% url 'manage_MLmodels_view' %}">Models ü§ñ</a></li>
            <li class="nav-item"><a class="nav-link" href="{% url 'testing_view' %}">Testing üß™</a></li>
            <li class="nav-item"><a class="nav-link" href="{% url 'predicting_view' %}">Predicting üîÆ</a></li>
            {% comment %} <li class="nav-item"><a class="nav-link" href="#">History üì∞</a></li> {% endcomment %}
          </ul>
        </div>
      </div>
    </nav>

    <!-- Main content -->
    <div class="container mt-4">
        {% block content %}{% endblock %}
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // This script dynamically populates target/feature selects based on the chosen dataset.
    // Selects a field with the exact name OR a name ending in '-fieldname'.
    const datasetSelect = document.querySelector('select[name="dataset"], select[name$="-dataset"]');
    const targetSelect = document.querySelector('select[name="target"], select[name$="-target"]');
    const featuresSelect = document.querySelector('select[name="features"], select[name$="-features"]');

    // The features select is optional 
    if (!datasetSelect || !targetSelect) {
        console.warn('Dataset or Target select not found. Aborting dynamic population script.');
        return;
    }

    // URL template generated by reverse (using 0 as placeholder)
    const urlTemplate = "{% url 'get_dataset_columns_view' 0 %}";
    function buildUrl(datasetId) {
        if (!datasetId) return null;
        return urlTemplate.replace(/0\/?$/, datasetId + '/');
    }

    // Values that the view might have injected (to maintain selection after error)
    const serverSelectedTarget = "{{ selected_target|default:''|escapejs }}";
    const serverSelectedFeatures = {{ selected_features_json|default:"[]"|safe }};

    function clearAndShowLoading() {
        targetSelect.innerHTML = '<option value="">Loading...</option>';
        if (featuresSelect) {
            featuresSelect.innerHTML = '';
        }
    }

    function populateSelects(columns) {
        targetSelect.innerHTML = '';
        const emptyOp = document.createElement('option');
        emptyOp.value = '';
        emptyOp.textContent = '--';
        targetSelect.appendChild(emptyOp);

        columns.forEach(col => {
            const opt = new Option(col, col);
            targetSelect.appendChild(opt);
        });

        // Reapply server selection, if any
        if (serverSelectedTarget) {
            const opt = Array.from(targetSelect.options).find(o => o.value === serverSelectedTarget);
            if (opt) opt.selected = true;
        }

        // Features (multiple), if the element exists
        if (featuresSelect) {
            featuresSelect.innerHTML = '';
            columns.forEach(col => {
                const opt = new Option(col, col);
                // Mark as selected if it was selected before (serverSelectedFeatures is an array)
                if (Array.isArray(serverSelectedFeatures) && serverSelectedFeatures.indexOf(col) !== -1) {
                    opt.selected = true;
                }
                featuresSelect.appendChild(opt);
            });
        }
    }

    function fetchAndPopulate(datasetId) {
        if (!datasetId) {
            targetSelect.innerHTML = '<option value="">Select a dataset first</option>';
            if (featuresSelect) featuresSelect.innerHTML = '';
            return;
        }
        const url = buildUrl(datasetId);
        if (!url) return;
        clearAndShowLoading();

        fetch(url, {credentials: 'same-origin'})
            .then(r => {
                if (!r.ok) throw new Error('HTTP ' + r.status);
                return r.json();
            })
            .then(data => {
                const cols = Array.isArray(data.columns) ? data.columns : [];
                if (cols.length === 0) {
                    targetSelect.innerHTML = '<option value="">No columns found</option>';
                    if (featuresSelect) featuresSelect.innerHTML = '';
                    return;
                }
                populateSelects(cols);
            })
            .catch(err => {
                console.error('Error fetching columns:', err);
                targetSelect.innerHTML = '<option value="">Error loading columns</option>';
                if (featuresSelect) featuresSelect.innerHTML = '';
            });
    }

    // Change event for the dataset select
    datasetSelect.addEventListener('change', function() {
        fetchAndPopulate(this.value);
    });

    // Auto-populate on page load if a dataset is already selected
    if (datasetSelect.value) {
        fetchAndPopulate(datasetSelect.value);
    }
});
</script>
{% endblock %}
