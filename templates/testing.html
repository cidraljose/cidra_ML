{% extends 'base.html' %}

{% block title %}Test Models - {{ block.super }}{% endblock %}

{% block content %}
<!-- Tab Navigation -->
<ul class="nav nav-tabs" id="testingTab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="evaluate-tab" data-bs-toggle="tab" data-bs-target="#evaluate-panel" type="button" role="tab" aria-controls="evaluate-panel" aria-selected="true">
            Test a Model
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history-panel" type="button" role="tab" aria-controls="history-panel" aria-selected="false">
            Tests History
        </button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="testingTabContent">
    <!-- Evaluation Panel -->
    <div class="tab-pane fade show active" id="evaluate-panel" role="tabpanel" aria-labelledby="evaluate-tab">
        <div class="row mt-3">
            <div class="col-md-6">
                <h2>Evaluate a Model</h2>
                <p>Select a trained model and a dataset to evaluate its performance.</p>
                
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %}">{{ message }}</div>
                    {% endfor %}
                {% endif %}

                <form method="post" novalidate>
                    {% csrf_token %}
                    {% for field in form %}
                        <div class="mb-3">
                            {{ field.label_tag }}
                            {{ field }}
                            {% if field.help_text %}
                                <small class="form-text text-muted">{{ field.help_text|safe }}</small>
                            {% endif %}
                            {% for error in field.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ error }}
                                </div>
                            {% endfor %}
                        </div>
                    {% endfor %}
                    <button type="submit" class="btn btn-primary mt-3">Evaluate Model</button>
                </form>

                <!-- Dynamic Info Display -->
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div id="model-info-container" class="d-none">
                            <h5>Model Details</h5>
                            <p><strong>Target:</strong> <span id="model-target"></span></p>
                            <p><strong>Features:</strong></p>
                            <ul id="model-features" class="list-group" style="max-height: 300px; overflow-y: auto;"></ul>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div id="dataset-info-container" class="d-none">
                            <h5>Dataset Details</h5>
                            <p><strong>Columns:</strong></p>
                            <ul id="dataset-columns" class="list-group" style="max-height: 300px; overflow-y: auto;"></ul>
                        </div>
                    </div>
                </div>

            </div>

        </div>
    </div>

    <!-- History Panel -->
    <div class="tab-pane fade" id="history-panel" role="tabpanel" aria-labelledby="history-tab">
        <div class="mt-3">
            <h2>All Test Results</h2>
            {% if history %}
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Model</th>
                            <th>Dataset</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for result in history %}
                        <tr id="result-row-{{ result.id }}" data-status="{{ result.status }}">
                            {% include "_test_result_row_partial.html" %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p class="text-muted">No test results found. Run an evaluation to see its history here.</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Results Modal -->
<div class="modal fade" id="resultsModal" tabindex="-1" aria-labelledby="resultsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="resultsModalLabel">Evaluation Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>Model:</strong> <span id="modal-model-name"></span></p>
        <p><strong>Dataset:</strong> <span id="modal-dataset-name"></span></p>
        <div class="row">
            <div class="col-md-5">
                <h5>Metrics</h5>
                <table class="table table-sm" id="modal-metrics-table">
                    <!-- Metrics will be populated by JS -->
                </table>
            </div>
            <div class="col-md-7">
                <h5>Plot of Predictions vs. Real Values</h5>
                <div id="modal-plot-container" class="text-center">
                    <!-- Plot image will be populated by JS -->
                </div>
            </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
// Runs only after the HTML document has been fully loaded
document.addEventListener('DOMContentLoaded', function () {
    // Get references to the HTML elements
    const modelSelect = document.getElementById('id_model');
    const datasetSelect = document.getElementById('id_dataset');

    // Elements for displaying model information
    const modelInfoContainer = document.getElementById('model-info-container');
    const modelTargetEl = document.getElementById('model-target');
    const modelFeaturesEl = document.getElementById('model-features');

    // Elements for displaying dataset information
    const datasetInfoContainer = document.getElementById('dataset-info-container');
    const datasetColumnsEl = document.getElementById('dataset-columns');

    // URLs for fetching data using Django's `url` tag. '0' is a placeholder for the ID.
    const modelDetailsUrlTemplate = "/models/PLACEHOLDER/details/";
    const datasetColumnsUrlTemplate = "/datasets/PLACEHOLDER/columns/";

    function buildUrl(template, id) {
        if (!id) return null;
        return template.replace('PLACEHOLDER', id);
    }

    function renderList(element, items) {
        // Clear any previous list items.
        element.innerHTML = '';
        if (items && items.length > 0) {
            items.forEach(item => {
                const li = document.createElement('li');
                li.className = 'list-group-item py-1';
                li.textContent = item;
                element.appendChild(li);
            });
        // If the list is empty, show a helpful message.
        } else {
            const li = document.createElement('li');
            li.className = 'list-group-item py-1 text-muted';
            li.textContent = 'No items to display.';
            element.appendChild(li);
        }
    }

    // Asynchronous function to fetch and display model details.
    async function fetchModelDetails(modelId) {
        const url = buildUrl(modelDetailsUrlTemplate, modelId);
         if (!url) {
            modelInfoContainer.classList.add('d-none'); // If no model is selected, hide the info
            return;
        }
        try {
            // Fetch data from the server's API endpoint
            const response = await fetch(url);
            if (!response.ok) throw new Error('Failed to fetch model details');
            const data = await response.json();

            // Populate the HTML elements with the received data
            modelTargetEl.textContent = data.target || 'Not specified';
            renderList(modelFeaturesEl, data.features);
            
            modelInfoContainer.classList.remove('d-none'); // Make info box visible
        } catch (error) {
            console.error(error);
            modelInfoContainer.classList.add('d-none');
        }
    }

    async function fetchDatasetColumns(datasetId) {
        const url = buildUrl(datasetColumnsUrlTemplate, datasetId);
        if (!url) {
            datasetInfoContainer.classList.add('d-none');
            return;
        }
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('Failed to fetch dataset columns');
            const data = await response.json();

            renderList(datasetColumnsEl, data.columns);
            datasetInfoContainer.classList.remove('d-none');
        } catch (error) {
            console.error(error);
            datasetInfoContainer.classList.add('d-none');
        }
    }

    // Attach event listeners to the dropdowns
    // When a change occurs, call the appropriate fetch function
    modelSelect.addEventListener('change', (e) => fetchModelDetails(e.target.value));
    datasetSelect.addEventListener('change', (e) => fetchDatasetColumns(e.target.value));

    // Initial load if values are pre-selected
    if (modelSelect.value) fetchModelDetails(modelSelect.value);
    if (datasetSelect.value) fetchDatasetColumns(datasetSelect.value);

    // --- Modal Logic ---
    const resultsModal = document.getElementById('resultsModal');
    if (resultsModal) {
        resultsModal.addEventListener('show.bs.modal', async function (event) {
            const button = event.relatedTarget;
            const resultId = button.getAttribute('data-result-id');
            const url = `/testing/results/${resultId}/details/`;

            // Get modal elements
            const modelNameEl = document.getElementById('modal-model-name');
            const datasetNameEl = document.getElementById('modal-dataset-name');
            const metricsTable = document.getElementById('modal-metrics-table');
            const plotContainer = document.getElementById('modal-plot-container');

            // Clear previous content
            metricsTable.innerHTML = '<tbody><tr><td>Loading...</td></tr></tbody>';
            plotContainer.innerHTML = '';

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to fetch results.');
                const data = await response.json();

                // Populate modal
                modelNameEl.textContent = data.model_name;
                datasetNameEl.textContent = data.dataset_name;

                // Populate metrics table
                let metricsHtml = '<tbody>';
                for (const [key, value] of Object.entries(data.metrics)) {
                    metricsHtml += `<tr><th>${key}</th><td>${parseFloat(value).toFixed(4)}</td></tr>`;
                }
                metricsHtml += '</tbody>';
                metricsTable.innerHTML = metricsHtml;

                // Populate plot
                if (data.plot) {
                    plotContainer.innerHTML = `<img src="data:image/png;base64,${data.plot}" class="img-fluid" alt="Evaluation Plot">`;
                } else {
                    plotContainer.innerHTML = '<p class="text-muted">No plot available for this evaluation (likely a classification task).</p>';
                }

            } catch (error) {
                console.error(error);
                metricsTable.innerHTML = '<tbody><tr><td>Failed to load results.</td></tr></tbody>';
            }
        });
    }

    // --- Error Modal Logic ---
    const errorModal = document.getElementById('errorModal');
    if (errorModal) {
        errorModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const errorTrace = button.getAttribute('data-error-trace');
            const errorContentEl = document.getElementById('error-trace-content');
            errorContentEl.textContent = errorTrace || 'No error details available.';
        });
    }

    // --- Tab Management ---
    // On page load, check if there's a URL hash and activate the corresponding tab.
    const hash = window.location.hash;
    if (hash) {
        const tabToActivate = document.querySelector(`button[data-bs-target="${hash}"]`);
        if (tabToActivate) {
            new bootstrap.Tab(tabToActivate).show();
        }
    }

    // --- Live Status Polling for Test Results ---
    const activePollers = new Map();
    const pollingInterval = 5000; // 5 seconds

    const pollStatus = async (resultId, rowElement) => {
        const url = `{% url 'get_test_result_row_partial_view' 0 %}`.replace('0', resultId);

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Server error: ${response.status}`);
            
            const newRowHtml = await response.text();
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = `<table><tbody><tr>${newRowHtml}</tr></tbody></table>`;
            const newStatus = tempDiv.querySelector('tr').dataset.status;

            // Replace the old row content with the new one.
            rowElement.innerHTML = newRowHtml;
            rowElement.dataset.status = newStatus; // Update the status attribute

            // If the new status is final, stop polling.
            if (newStatus === 'COMPLETED' || newStatus === 'FAILED') {
                clearInterval(activePollers.get(resultId));
                activePollers.delete(resultId);
            }
        } catch (error) {
            console.error(`Failed to poll status for result ${resultId}:`, error);
            clearInterval(activePollers.get(resultId)); // Stop on error
            activePollers.delete(resultId);
        }
    };

    // Find all rows that are currently pending or running and start polling them.
    document.querySelectorAll('tr[data-status="PENDING"], tr[data-status="RUNNING"]').forEach(row => {
        const resultId = row.id.split('-').pop();
        if (resultId && !activePollers.has(resultId)) {
            const intervalId = setInterval(() => pollStatus(resultId, row), pollingInterval);
            activePollers.set(resultId, intervalId);
        }
    });
});
</script>
{% endblock %}