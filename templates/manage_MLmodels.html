{% extends "base.html" %}
{% block title %}Manage ML Models{% endblock %}
{% block content %}

<div class="container mt-4">
    <h1 class="mb-4">Manage ML Models</h1>

    <!-- Tabs for Train and Upload -->
    <ul class="nav nav-tabs" id="modelTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="train-tab" data-bs-toggle="tab" data-bs-target="#train-panel" type="button" role="tab" aria-controls="train-panel" aria-selected="true">Train New Model</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload-panel" type="button" role="tab" aria-controls="upload-panel" aria-selected="false">Upload Existing Model</button>
        </li>
    </ul>
    <div class="tab-content" id="modelTabsContent">
        <!-- Train Model Panel -->
        <div class="tab-pane fade show active" id="train-panel" role="tabpanel" aria-labelledby="train-tab">
            <div class="card card-body mt-3">
                <h5 class="card-title">Train a New Model with AutoGluon</h5>
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6 mb-3">{{ train_form.name.label_tag }} {{ train_form.name }}</div>
                        <div class="col-md-6 mb-3">{{ train_form.dataset.label_tag }} {{ train_form.dataset }}</div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ train_form.target.label_tag }}
                            {{ train_form.target }}
                            <div class="form-text">{{ train_form.target.help_text }}</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ train_form.features.label_tag }}
                            {{ train_form.features }}
                            <div class="form-text">{{ train_form.features.help_text }}</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">{{ train_form.time_limit.label_tag }} {{ train_form.time_limit }}</div>
                        <div class="col-md-6 mb-3">{{ train_form.presets.label_tag }} {{ train_form.presets }}</div>
                    </div>
                    <button type="submit" name="train_model" class="btn btn-primary">Start Training</button>
                </form>
            </div>
        </div>

        <!-- Upload Model Panel -->
        <div class="tab-pane fade" id="upload-panel" role="tabpanel" aria-labelledby="upload-tab">
            <div class="card card-body mt-3">
                <h5 class="card-title">Upload a Pre-trained Model</h5>
                <p class="card-text">Upload a model as a .zip file, typically from a previously trained AutoGluon `predictor.save()` artifact.</p>
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    {{ upload_form.as_p }}
                    <button type="submit" name="upload_model" class="btn btn-secondary">Upload Model</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Existing Models Table -->
    <h2 class="mt-5">Existing Models</h2>
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th scope="col">Name</th>
                    <th scope="col">Status</th>
                    <th scope="col">Related Dataset</th>
                    <th scope="col">Created</th>
                    <th scope="col">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for model in models %}
                <tr>
                    <td>{{ model.name }}</td>
                    <td>
                        {% if model.status == 'TRAINING' %}
                            <span class="badge bg-warning text-dark">{{ model.get_status_display }} <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span></span>
                        {% elif model.status == 'COMPLETED' %}
                            <span class="badge bg-success">{{ model.get_status_display }}</span>
                        {% elif model.status == 'FAILED' %}
                            <span class="badge bg-danger">{{ model.get_status_display }}</span>
                        {% else %}
                            <span class="badge bg-secondary">{{ model.get_status_display }}</span>
                        {% endif %}
                    </td>
                    <td>{{ model.related_dataset.name|default:"N/A" }}</td>
                    <td>{{ model.date|date:"Y-m-d H:i" }}</td>
                    <td>
                        <a href="{% url 'visualize_MLmodel_view' model.id %}"
                            class="btn btn-sm btn-info mb-2 visualize-btn" 
                            <i class="bi bi-eye-fill"></i>
                            Visualizar
                        </a>
                        {% if model.file %}
                        <a href="{% url 'download_MLmodel_view' model.id %}"
                            class="btn btn-sm btn-success mb-2">
                            Download
                        </a>
                        {% endif %}
                        <a href="{% url 'delete_MLmodel_view' model.id %}" 
                            class="btn btn-sm btn-danger mb-2" 
                            onclick="return confirm('Tem certeza que deseja excluir esse modelo?');">
                            Deletar
                        </a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center">No models found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tries to locate by IDs (prefix 'train') or by name if ID doesn't exist
    const datasetSelect = document.getElementById('id_train-dataset') || document.querySelector('select[name="train-dataset"]');
    const targetSelect = document.getElementById('id_train-target') || document.querySelector('select[name="train-target"]');
    const featuresSelect = document.getElementById('id_train-features') || document.querySelector('select[name="train-features"]');

    if (!datasetSelect || !targetSelect || !featuresSelect) {
        console.warn('Elementos do form não encontrados:', {datasetSelect, targetSelect, featuresSelect});
        return;
    }

    // URL template generated by reverse (using 0 as placeholder)
    const urlTemplate = "{% url 'get_dataset_columns_view' 0 %}";
    function buildUrl(datasetId) {
        if (!datasetId) return null;
        return urlTemplate.replace(/0\/?$/, datasetId + '/');
    }

    // Values that the view might have injected (to maintain selection after error)
    const serverSelectedTarget = "{{ selected_target|default:''|escapejs }}";
    const serverSelectedFeatures = {{ selected_features_json|default:"[]"|safe }};

    function clearAndShowLoading() {
        targetSelect.innerHTML = '<option value="">Loading...</option>';
        featuresSelect.innerHTML = '';
    }

    function populateSelects(columns) {
        // target
        targetSelect.innerHTML = '';
        const emptyOp = document.createElement('option');
        emptyOp.value = '';
        emptyOp.textContent = '---------';
        targetSelect.appendChild(emptyOp);

        columns.forEach(col => {
            const opt = new Option(col, col);
            targetSelect.appendChild(opt);
        });

        // Reapply server selection, if any
        if (serverSelectedTarget) {
            const opt = Array.from(targetSelect.options).find(o => o.value === serverSelectedTarget);
            if (opt) opt.selected = true;
        }

        featuresSelect.innerHTML = '';
        // Features (multiple)
        columns.forEach(col => {
            const opt = new Option(col, col);
            // marca se estava selecionado antes (serverSelectedFeatures é array)
            if (Array.isArray(serverSelectedFeatures) && serverSelectedFeatures.indexOf(col) !== -1) {
                opt.selected = true;
            }
            featuresSelect.appendChild(opt);
        });
    }

    function fetchAndPopulate(datasetId) {
        if (!datasetId) {
            targetSelect.innerHTML = '<option value="">Select a dataset first</option>';
            featuresSelect.innerHTML = '';
            return;
        }
        const url = buildUrl(datasetId);
        if (!url) return;
        clearAndShowLoading();

        fetch(url, {credentials: 'same-origin'})
            .then(r => {
                if (!r.ok) throw new Error('HTTP ' + r.status);
                return r.json();
            })
            .then(data => {
                const cols = Array.isArray(data.columns) ? data.columns : [];
                if (cols.length === 0) {
                    targetSelect.innerHTML = '<option value="">No columns found</option>';
                    featuresSelect.innerHTML = '';
                    return;
                }
                populateSelects(cols);
            })
            .catch(err => {
                console.error('Error fetching columns:', err);
                targetSelect.innerHTML = '<option value="">Error loading columns</option>';
                featuresSelect.innerHTML = '';
            });
    }

    // Change event for the dataset select
    datasetSelect.addEventListener('change', function() {
        fetchAndPopulate(this.value);
    });

    // auto-popula ao carregar caso já haja um dataset selecionado (ex.: reload com form com erro)
    if (datasetSelect.value) {
        fetchAndPopulate(datasetSelect.value);
    }
});
</script>
{% endblock %}
