{% extends 'base.html' %}
{% block title %}Datasets{% endblock %}
{% block content %} 

<h2 class="mb-4">Dataset Management</h2>

<!-- Tabs for different actions -->
<ul class="nav nav-tabs" id="datasetTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="list-tab" data-bs-toggle="tab" data-bs-target="#list-panel" type="button" role="tab" aria-controls="list-panel" aria-selected="true">Available Datasets</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload-panel" type="button" role="tab" aria-controls="upload-panel" aria-selected="false">Upload New Dataset</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="split-tab" data-bs-toggle="tab" data-bs-target="#split-panel" type="button" role="tab" aria-controls="split-panel" aria-selected="false">Split Dataset</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="merge-tab" data-bs-toggle="tab" data-bs-target="#merge-panel" type="button" role="tab" aria-controls="merge-panel" aria-selected="false">Merge Datasets</button>
    </li>
</ul>

<div class="tab-content" id="datasetTabsContent">
    <!-- Panel 1: List available datasets -->
    <div class="tab-pane fade show active" id="list-panel" role="tabpanel" aria-labelledby="list-tab">
        <div class="table-responsive mt-3">
            <table class="table table-bordered table-hover">
                <thead class="table-light">
                    <tr>
                        <th>Name</th>
                        <th>Description</th>
                        <th>Rows</th>
                        <th>Columns</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ds in datasets %}
                    <tr>
                        <td>{{ ds.name }}</td>
                        <td>{{ ds.description|default:"-" }}</td>            
                        <td>{{ ds.n_rows }}</td>
                        <td>
                            <ul class="list-unstyled mb-0">
                                {% for col, type in ds.columns.items %}
                                    <li><small>{{ col }} ({{ type }})</small></li>
                                {% endfor %}
                            </ul>
                        </td>
                        <td>
                            <button type="button" class="btn btn-sm btn-info mb-1 visualize-btn" data-url="{% url 'visualize_dataset_view' ds.pk %}" data-bs-toggle="modal" data-bs-target="#visualizationModal">Visualize</button>
                            <a href="{% url 'download_dataset_view' ds.pk %}" class="btn btn-sm btn-success mb-1">Download</a>
                            <a href="{% url 'delete_dataset_view' ds.pk %}" class="btn btn-sm btn-danger mb-1" onclick="return confirm('Are you sure you want to permanently delete this dataset?');">Delete</a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center">No datasets found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Panel 2: Upload new data -->
    <div class="tab-pane fade" id="upload-panel" role="tabpanel" aria-labelledby="upload-tab">
        <div class="card card-body mt-3">
            <h5 class="card-title">Add New Data</h5>
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                {% for field in upload_form %}
                    <div class="mb-3">
                        {{ field.label_tag }}
                        {{ field }}
                        {% if field.help_text %}<small class="form-text text-muted">{{ field.help_text }}</small>{% endif %}
                        {% for error in field.errors %}<div class="alert alert-danger mt-1 p-2">{{ error }}</div>{% endfor %}
                    </div>
                {% endfor %}
                {% for error in upload_form.non_field_errors %}<div class="alert alert-danger p-2">{{ error }}</div>{% endfor %}
                <button type="submit" name="upload_csv" class="btn btn-primary">Upload Dataset</button>
            </form>
        </div>
    </div>

    <!-- Panel 3: Split a dataset -->
    <div class="tab-pane fade" id="split-panel" role="tabpanel" aria-labelledby="split-tab">
        <div class="card card-body mt-3">
            <h5 class="card-title">Split a Dataset into Training and Test Sets</h5>
            <p class="card-text">This will create two new datasets: `(name)_train` and `(name)_test`.</p>
            <form method="post">
                {% csrf_token %}
                {% for field in split_form %}
                    <div class="mb-3">
                        {{ field.label_tag }}
                        {{ field }}
                        {% if field.help_text %}<small class="form-text text-muted">{{ field.help_text }}</small>{% endif %}
                        {% for error in field.errors %}<div class="alert alert-danger mt-1 p-2">{{ error }}</div>{% endfor %}
                    </div>
                {% endfor %}
                {% for error in split_form.non_field_errors %}<div class="alert alert-danger p-2">{{ error }}</div>{% endfor %}
                <button type="submit" name="split_dataset" class="btn btn-primary">Split Dataset</button>
            </form>
        </div>
    </div>

    <!-- Panel 4: Merge datasets -->
    <div class="tab-pane fade" id="merge-panel" role="tabpanel" aria-labelledby="merge-tab">
        <div class="card card-body mt-3">
            <h5 class="card-title">Merge Multiple Datasets</h5>
            <p class="card-text">Select multiple datasets to merge them vertically (append rows). The new dataset will contain rows from all selected datasets. Columns will be aligned by name.</p>
            <form method="post">
                {% csrf_token %}
                {% for field in merge_form %}
                    <div class="mb-3">
                        {{ field.label_tag }}
                        {{ field }}
                        {% if field.help_text %}<small class="form-text text-muted">{{ field.help_text }}</small>{% endif %}
                        {% for error in field.errors %}<div class="alert alert-danger mt-1 p-2">{{ error }}</div>{% endfor %}
                    </div>
                {% endfor %}
                <div id="merge-columns-container" class="mb-3"></div>
                <button type="submit" name="merge_datasets" class="btn btn-primary">Merge Datasets</button>
            </form>
        </div>
    </div>
</div>

<!-- Visualization Modal -->
<div class="modal fade" id="visualizationModal" tabindex="-1" aria-labelledby="visualizationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header justify-content-between">
        <h5 class="modal-title" id="visualizationModalLabel">
            Dataset Visualization: "<span id="modalDatasetName"></span>"
        </h5>
        <div class="d-flex align-items-center">
            <div id="modalRefreshButtonContainer" class="me-2"></div>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
      </div>
      <div class="modal-body" id="visualizationModalBody">
        <!-- Content will be loaded here by JavaScript -->
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- Logic for Merge Datasets Tab ---
    const mergeDatasetsSelect = document.getElementById('{{ merge_form.datasets.id_for_label }}');
    const mergeColumnsContainer = document.getElementById('merge-columns-container');

    if (mergeDatasetsSelect) {
        mergeDatasetsSelect.addEventListener('change', function() {
            const selectedDatasetIds = Array.from(this.selectedOptions).map(option => option.value);
            mergeColumnsContainer.innerHTML = ''; // Clear previous column selectors

            if (selectedDatasetIds.length > 0) {
                // Show a loading spinner
                mergeColumnsContainer.innerHTML = `
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                        <strong class="ms-2">Loading columns...</strong>
                    </div>`;

                fetch("{% url 'get_multiple_dataset_columns_view' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ dataset_ids: selectedDatasetIds })
                })
                .then(response => response.json())
                .then(data => {
                    mergeColumnsContainer.innerHTML = ''; // Clear loading spinner
                    for (const [datasetId, details] of Object.entries(data.columns_data)) {
                        let optionsHtml = details.columns.map(col => `<option value="${col}" selected>${col}</option>`).join('');
                        let fieldHtml = `
                            <div class="mb-3">
                                <label for="id_columns_${datasetId}" class="form-label">Columns for <strong>${details.name}</strong></label>
                                <select name="columns_${datasetId}" multiple class="form-select" size="6" id="id_columns_${datasetId}">
                                    ${optionsHtml}
                                </select>
                            </div>`;
                        mergeColumnsContainer.innerHTML += fieldHtml;
                    }
                })
                .catch(error => console.error('Error fetching columns for merging:', error));
            }
        });
    }

    // --- Logic for Visualization Modal ---
    const visualizationModal = document.getElementById('visualizationModal');
    if (visualizationModal) {
        visualizationModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const url = button.dataset.url;
            const modalBody = document.getElementById('visualizationModalBody');

            // Show a loading message inside the modal
            modalBody.innerHTML = `
                <div class="d-flex justify-content-center align-items-center" style="min-height: 200px;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <strong class="ms-3">Generating visualizations...</strong>
                </div>`;

            fetch(url)
                .then(response => response.text())
                .then(html => {
                    // Create a temporary div to parse the incoming HTML
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = html;

                    // Find the header and the content within the partial
                    const partialHeader = tempDiv.querySelector('.card-header');
                    const partialBody = tempDiv.querySelector('.card-body');

                    // Move the refresh button and set the dataset name in the modal's main header
                    document.getElementById('modalDatasetName').textContent = partialHeader.querySelector('h3').textContent.replace('Dataset: ', '');
                    document.getElementById('modalRefreshButtonContainer').innerHTML = partialHeader.querySelector('div').innerHTML;

                    // Set the modal body with the remaining content
                    modalBody.innerHTML = partialBody ? partialBody.innerHTML : 'Could not parse content.';
                })
                .catch(error => {
                    console.error('Error fetching visualization:', error);
                    modalBody.innerHTML = '<div class="alert alert-danger">Could not load visualizations. Please try again.</div>';
                });
        });

        // Handle the refresh button inside the modal
        visualizationModal.addEventListener('click', function(event) {
            if (event.target.classList.contains('refresh-plots-btn')) {
                const modalBody = document.getElementById('visualizationModalBody');
                const url = event.target.dataset.url;

                // Clear the refresh button while loading to prevent double clicks
                document.getElementById('modalRefreshButtonContainer').innerHTML = '';

                // Show a loading message inside the modal
                modalBody.innerHTML = `
                    <div class="d-flex justify-content-center align-items-center" style="min-height: 200px;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <strong class="ms-3">Refreshing visualizations...</strong>
                    </div>`;

                fetch(url)
                    .then(response => response.text())
                    .then(html => {
                        // Re-run the same logic as the initial load
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = html;

                        const partialHeader = tempDiv.querySelector('.card-header');
                        const partialBody = tempDiv.querySelector('.card-body');

                        // Restore the refresh button and dataset name
                        document.getElementById('modalDatasetName').textContent = partialHeader.querySelector('h3').textContent.replace('Dataset: ', '');
                        document.getElementById('modalRefreshButtonContainer').innerHTML = partialHeader.querySelector('div').innerHTML;

                        // Update the body
                        if (partialBody) {
                            modalBody.innerHTML = partialBody.innerHTML;
                        }
                    })
                    .catch(error => {
                        console.error('Error refreshing visualization:', error);
                        modalBody.innerHTML = '<div class="alert alert-danger">Could not refresh visualizations. Please try again.</div>';
                    });
            }
        });
    }
});
</script>
{% endblock %}
