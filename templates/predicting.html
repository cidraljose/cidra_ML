{% extends 'base.html' %}

{% block title %}Make Predictions - {{ block.super }}{% endblock %}

{% block content %}
<!-- Tab Navigation -->
<ul class="nav nav-tabs" id="predictingTab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="predict-tab" data-bs-toggle="tab" data-bs-target="#predict-panel" type="button" role="tab" aria-controls="predict-panel" aria-selected="true">
            Make a Prediction
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history-panel" type="button" role="tab" aria-controls="history-panel" aria-selected="false">
            Prediction History
        </button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="predictingTabContent">
    <!-- Prediction Panel -->
    <div class="tab-pane fade show active" id="predict-panel" role="tabpanel" aria-labelledby="predict-tab">
        <div class="row mt-3">
            <div class="col-md-6">
                <h2>Evaluate a Model</h2>
                <p>Select a trained model and a dataset to evaluate its performance.</p>
                
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %}">{{ message }}</div>
                    {% endfor %}
                {% endif %}

                <form method="post" novalidate>
                    {% csrf_token %}
                    {% for field in form %}
                        <div class="mb-3">
                            {{ field.label_tag }}
                            {{ field }}
                            {% if field.help_text %}
                                <small class="form-text text-muted">{{ field.help_text|safe }}</small>
                            {% endif %}
                            {% for error in field.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ error }}
                                </div>
                            {% endfor %}
                        </div>
                    {% endfor %}
                    <button type="submit" class="btn btn-primary mt-3">Run Prediction</button>
                </form>

                <!-- Dynamic Info Display -->
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div id="model-info-container" class="d-none">
                            <h5>Model Details</h5>
                            <p><strong>Target:</strong> <span id="model-target"></span></p>
                            <p><strong>Features:</strong></p>
                            <ul id="model-features" class="list-group" style="max-height: 300px; overflow-y: auto;"></ul>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div id="dataset-info-container" class="d-none">
                            <h5>Dataset Details</h5>
                            <p><strong>Columns:</strong></p>
                            <ul id="dataset-columns" class="list-group" style="max-height: 300px; overflow-y: auto;"></ul>
                        </div>
                    </div>
                </div>

            </div>

        </div>
    </div>

    <!-- History Panel -->
    <div class="tab-pane fade" id="history-panel" role="tabpanel" aria-labelledby="history-tab">
        <div class="mt-3">
            <h2>All Prediction Results</h2>
            {% if history %}
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Model</th>
                            <th>Input Dataset</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for result in history %}
                        <tr>
                            <td>{{ result.prediction_date|date:"Y-m-d H:i" }}</td>
                            <td>{{ result.model.name }}</td>
                            <td>{{ result.dataset.name }}</td>
                            <td>
                                <a href="{% url 'download_prediction_view' result.id %}" class="btn btn-sm btn-success" title="Download dataset with predictions">
                                    Download
                                </a>
                                <!-- Delete Form -->
                                <form method="post" action="{% url 'delete_prediction_view' result.id %}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this prediction result?');">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p class="text-muted">No prediction results found. Run a prediction to see its history here.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- Tab Management ---
    // On page load, check if there's a URL hash and activate the corresponding tab.
    const hash = window.location.hash;
    if (hash) {
        const tabToActivate = document.querySelector(`button[data-bs-target="${hash}"]`);
        if (tabToActivate) {
            new bootstrap.Tab(tabToActivate).show();
        }
    }
});
</script>
{% endblock %}